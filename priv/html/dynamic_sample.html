<!DOCTYPE html>
<html>
  <head>
  </head>
  <body>
    <script lang="javascript">
      var minefield_id = "minefield";
      
      // Data definitions
      
      // A Cell is one of:
      // - mine
      // - unknown
      // - empty
      // - Integer = the amount of neighbouring mines
      var cell_mine = "mine";
      var cell_hidden = "hidden";
      var cell_empty = "empty";
      var cell_neighbours = 3;
      
      function cell_template(cell) {
        switch (cell) {
          case "mine":
            // Cell is a mine
            break;
          case "unknown":
            // Cell is unknown
            break;
          case "empty":
            // Cell is empty
            break;
          default:
            // Cell is number of neighbours
            break;
        }
      }
      
      // A Minefield is [[Cell]].
      // interp. A 2D-array of cells.
      var minefield_sample = [
        ["mine", "hidden", "empty"],
        [1, 1, "empty"],
        ["empty", "empty", "empty"]
      ];
      
      function minefield_template(minefield) {
        minefield.forEach(function (minefield_row) {
          row.forEach(function (cell) {
            cell_template(cell);
          });
        });
      }
      
      // Functions
      
      // Produce the textual representation of the Cell.
      function cell_to_html(row, col, cell) {
        var retval = "";
        
        switch (cell) {
          case "mine":
            retval = "X";
            break;
          case "hidden":
            retval = "<a href='javascript:void(0)' onclick='open_cell(" + row + "," + col + ");'>o</a>"
              + "/"
              + "<a href='javascript:void(0)' onclick='mark_cell(" + row + "," + col + ");'>m</a>";
            break;
          case "flag":
            retval = "<a href='javascript:void(0)' onclick='unmark_cell(" + row + "," + col + ");'>f</a>"
            break;
          case "false_flag":
            retval = "N";
            break;
          case "empty":
            retval = "&nbsp;";
            break;
          case "0":
            retval = "&nbsp;";
            break;
          default:
            retval = cell;
        }
        
        return retval
      }
      
      // Produce the minefield HTML data inside element minefield_id.
      function render_minefield(minefield) {
        var minefield_element = document.getElementById(minefield_id);

        var inner_html = "";

        minefield.forEach(function (row, i) {
          
          inner_html += "<tr>";
          
          row.forEach(function (cell, j) {
            inner_html += "<td>";
            inner_html += cell_to_html(i + 1, j + 1, cell);
            inner_html += "</td>";
          });
          
          inner_html += "</tr>";
          
        });

        minefield_element.innerHTML = inner_html;
      }
      
      function start_new_game() {
        var request = new_request();
        request.open('POST', '/api/new', true);
        request.send();
      }
      
      // Send an open command.
      function open_cell(row, col) {
        var request = new_request();
        request.open('POST', '/api/open', true);
        request.send(JSON.stringify({'row': row, 'col': col}));
      }
      
      // Send a mark command.
      function mark_cell(row, col) {
        var request = new_request();
        request.open('POST', '/api/mark', true);
        request.send(JSON.stringify({'row': row, 'col': col}));
      }
      
      // Send an unmark command.
      function unmark_cell(row, col) {
        var request = new_request();
        request.open('POST', '/api/unmark', true);
        request.send(JSON.stringify({'row': row, 'col': col}));
      }
      
      // Produce a new XMLHttpRequest, which renders the board on response.
      function new_request() {
        var request = new XMLHttpRequest();
        request.onreadystatechange = function(event) {
          if (request.readyState == 4 && request.status == 200) {
            var data = JSON.parse(request.responseText);
            var state = data.state;
            var board = data.board;
            var minefield = parse_minefield(board.rows, board.cols, board.data);
            render_minefield(minefield);
          } else if (request.readyState == 4) {
            console.log("Error (HTTP code " + request.status + "): " + request.responseText);
          }
        };
        return request;
      }
      
      // Produce a 2D-array of the server sent minefield.
      function parse_minefield(rows, cols, data) {
        var minefield = [];
        for (var row = 0; row < rows; row++) {
          var row_data = [];
          for (var col = 0; col < cols; col++) {
            row_data.push(data[row*cols + col]);
          }
          minefield.push(row_data);
        }
        return minefield;
      }
      
    </script>

    <h1>Minesweeper</h1>
    <p>Game ID #1234</p>
    <table id="minefield">
    </table>
    
    <button onclick="start_new_game();">New Game</button>
    

  </body>
</html>